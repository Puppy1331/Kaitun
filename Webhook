-- SendToWebhook.lua
-- Gửi dữ liệu account/seeds/units + account age lên webhook website

local _wait = task.wait
repeat _wait() until game:IsLoaded()

local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local HttpService = game:GetService("HttpService")

-- Modules
local logicRoot = Player:WaitForChild("PlayerGui"):WaitForChild("LogicHolder")
local modulesDir = logicRoot:WaitForChild("ClientLoader"):WaitForChild("Modules")
local ClientDataHandler = require(modulesDir:WaitForChild("ClientDataHandler"))
local SharedItemData   = require(modulesDir:WaitForChild("SharedItemData"))

-- Hàm gửi webhook
local function SendToWebhook(url, data)
    local headers = {["Content-Type"] = "application/json"}
    local body = HttpService:JSONEncode(data)

    if syn and syn.request then
        syn.request({Url = url, Method = "POST", Headers = headers, Body = body})
        print("[Webhook] Sent via syn.request")
    elseif request then
        request({Url = url, Method = "POST", Headers = headers, Body = body})
        print("[Webhook] Sent via request")
    else
        warn("❌ Không có syn.request hoặc request")
    end
end

-- Chuẩn hóa số seeds
local function normalizeSeeds(seedsStr)
    seedsStr = tostring(seedsStr):gsub(",", "") -- bỏ dấu phẩy
    local num = tonumber(seedsStr:match("%d+"))
    if not num then return 0 end

    if seedsStr:lower():find("k") then
        return num * 1000
    elseif seedsStr:lower():find("m") then
        return num * 1000000
    else
        return num
    end
end

-- Thu thập dữ liệu & gửi
local function collectAndSend()
    local inventory = ClientDataHandler.GetValue("Inventory")
    local Seeds = Player.leaderstats.Seeds.Value
    local SeedHave = normalizeSeeds(Seeds)

    local List = {}
    for uniqueId, unitData in pairs(inventory or {}) do
        local itemId = unitData.ItemData and unitData.ItemData.ID
        if itemId then
            local cfgModule = Player.PlayerGui.LogicHolder.ClientLoader.SharedConfig.ItemData.Units.Configs:FindFirstChild(itemId)
            if cfgModule then
                local cfg = require(cfgModule)
                if cfg and cfg.Rarity == "ra_godly" 
                   and itemId ~= "unit_fire_flower"
                   and itemId ~= "unit_stun_flower"
                   and itemId ~= "unit_zapper"
                   and itemId ~= "unit_passionfruit"
                   and itemId ~= "unit_banana" then
                    table.insert(List, {id = itemId, uuid = uniqueId})
                end
            end
        end
    end

    local data = {
        account = Player.Name,
        account_age = Player.AccountAge,
        seeds = SeedHave,
        units = List,
        last_update = os.time()
    }

    local url = "http://accountgiare.info.vn/webhook.php"
    SendToWebhook(url, data)
end

-- Lặp 30s
while true do
    collectAndSend()
    task.wait(30)
end
